## 一、业务目标（核心）

这是一个 **运营策划对话式编辑系统（MVP）** 的后端。

系统内：

- **始终只有一个当前生效的 Markdown 文档**
- 文档可以通过：
    - 人工编辑保存
    - LLM 对话修改
- **每一次修改都会生成一个新版本**
- 支持：
    - 查看历史版本
    - 回退到任意历史版本（回退本身也算一次新版本）

---

## 二、需要补充的模块（允许新增文件）

请在现有工程下，新增并实现以下模块（如不存在）：

```
backend/src/app/
├── models/
│   ├── __init__.py
│   ├── document.py
│   └── document_version.py
├── schemas/
│   ├── __init__.py
│   ├── document.py
│   └── version.py
├── services/
│   ├── __init__.py
│   ├── document_service.py
│   ├── version_service.py
│   └── llm_service.py
├── api/
│   ├── document.py
│   ├── chat.py
│   └── version.py
└── database.py
```

> 如果某个目录已存在但为空，可以直接补充  
> 不允许改名已有目录

---

## 三、数据与持久化要求

### 数据库

- 使用 **Mysql**
- 使用 SQLAlchemy 或 SQLModel
- 如果你需要建库、建表可以使用mysql的mcp
- 建库建表的sql语句保留到backend/src/sql目录下

---

### 核心模型

#### Document

- `id`
- `current_content`（Markdown 文本）
- `current_version`（int）

#### DocumentVersion

- `id`
- `document_id`
- `version_number`
- `content_md`
- `diff`
- `created_at`

---

## 四、版本管理逻辑（重点）

- 每次文档被修改（无论来源）：
    
    1. 读取旧内容
    2. 使用 `difflib` 生成 diff
    3. 保存一条 `DocumentVersion`
    4. 更新 Document 当前内容与版本号
- 回退逻辑：
    - 回退到某一历史版本
    - **不是覆盖**
    - 而是：
        - 读取目标版本内容
        - 作为“新修改”再生成一个新版本

---

## 五、API 设计（必须实现）

请在 `api/` 下实现以下接口：

### 文档

- `GET /document`
- `PUT /document`
    - body：`content_md`

---

### 对话修改文档

- `POST /chat`
    - body：`user_message`
    - 行为：
        - 读取当前 Markdown
        - 构造 LLM Prompt
        - 调用 LLM
        - 得到 **修改后的完整 Markdown**
        - 保存新版本
        - 返回最新 Markdown

---

### 版本管理

- `GET /versions`
- `POST /versions/{version_id}/rollback`

---

## 六、LLM Service 要求（非常重要）

### Prompt 模板（必须原样实现）

`你是一个专业的运营策划专家。 下面是当前的运营策划文档（Markdown）：  <<<CURRENT_MD>>>  用户的新要求是： <<<USER_INPUT>>>  请在尽量保持原有结构的前提下， 直接输出【修改后的完整 Markdown 文档】。 不要输出任何解释或多余文字。`

### 模型调用要求

- 可以使用 **mock / placeholder**
- 结构要清晰，方便后续替换为真实模型
- 不要写死某一家模型 SDK

---

## 七、工程与代码要求

- 所有 Service 层：
    - 不直接依赖 FastAPI
- API 层：
    - 只负责 HTTP
- 每个文件顶部加一句注释：
    - 说明该文件的职责
- 关键逻辑必须写注释（尤其是版本生成与回退）

---

## 八、验收标准（你必须确保）

> 当我启动服务后：

- `GET /health` 正常
- `GET /document` 能返回当前 Markdown
- `POST /chat` 会生成新版本
- `GET /versions` 能看到历史
- `POST /versions/{id}/rollback` 能正确回退

---

## 九、工程哲学（请遵守）

- **MVP 优先**
- **可读性 > 抽象性**
- 不要过度设计
- 这是一个「给下一阶段继续扩展用」的后端

---

如果你不确定某个设计点，  
**请选择“最简单、最直观、最好维护”的方案**。