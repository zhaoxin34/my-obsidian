# Pattern Syntax

> åŸæ–‡: https://ast-grep.github.io/guide/pattern-syntax.html

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç» ast-grep çš„æ¨¡å¼è¯­æ³•ã€‚ç¤ºä¾‹å°†ä½¿ç”¨ JavaScript ç¼–å†™ï¼Œä½†åŸºæœ¬åŸç†åŒæ ·é€‚ç”¨äºå…¶ä»–è¯­è¨€ã€‚

## æ¨¡å¼åŒ¹é… (Pattern Matching)

ast-grep ä½¿ç”¨æ¨¡å¼ä»£ç æ„å»º AST æ ‘ï¼Œå¹¶å°†å…¶ä¸ç›®æ ‡ä»£ç è¿›è¡ŒåŒ¹é…ã€‚æ¨¡å¼ä»£ç å¯ä»¥æœç´¢å®Œæ•´çš„è¯­æ³•æ ‘ï¼Œå› æ­¤æ¨¡å¼ä¹Ÿå¯ä»¥åŒ¹é…åµŒå¥—è¡¨è¾¾å¼ã€‚ä¾‹å¦‚ï¼Œæ¨¡å¼ `a + 1` å¯ä»¥åŒ¹é…ä»¥ä¸‹æ‰€æœ‰ä»£ç ï¼š

```javascript
const b = a + 1

funcCall(a + 1)

deeplyNested({
  target: a + 1
})
```

> âš ï¸ **è­¦å‘Š**: æ¨¡å¼ä»£ç å¿…é¡»æ˜¯ tree-sitter å¯ä»¥è§£æçš„æœ‰æ•ˆä»£ç ã€‚
>
> [ast-grep playground](https://ast-grep.github.io/playground.html) æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„å·¥å…·ï¼Œå¯ä»¥ç¡®è®¤æ¨¡å¼æ˜¯å¦è¢«æ­£ç¡®è§£æã€‚
>
> å¦‚æœ ast-grep æ— æ³•æŒ‰é¢„æœŸè§£æä»£ç ï¼Œå¯ä»¥å°è¯•é€šè¿‡ä½¿ç”¨å¯¹è±¡æ ·å¼çš„æ¨¡å¼æ¥æä¾›æ›´å¤šä¸Šä¸‹æ–‡ã€‚

## å…ƒå˜é‡ (Meta Variable)

é€šå¸¸ï¼Œæˆ‘ä»¬å¸Œæœ›ç¼–å†™æ¨¡å¼æ¥åŒ¹é…åŠ¨æ€å†…å®¹ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…ƒå˜é‡æ¥åŒ¹é…æ¨¡å¼ä¸­çš„å­è¡¨è¾¾å¼ã€‚

å…ƒå˜é‡ä»¥ `$` ç¬¦å·å¼€å¤´ï¼Œåè·Ÿç”±å¤§å†™å­—æ¯ A-Zã€ä¸‹åˆ’çº¿ `_` æˆ–æ•°å­— 1-9 ç»„æˆçš„åç§°ã€‚`$META_VARIABLE` æ˜¯ä¸€ä¸ªå¯ä»¥åŒ¹é…ä»»ä½•å•ä¸ª AST èŠ‚ç‚¹çš„é€šé…ç¬¦è¡¨è¾¾å¼ã€‚

å¯ä»¥å°†å…¶è§†ä¸ºæ­£åˆ™è¡¨è¾¾å¼ä¸­çš„ `.`ï¼Œä½†å®ƒä¸æ˜¯æ–‡æœ¬åŒ¹é…ã€‚

**æœ‰æ•ˆçš„å…ƒå˜é‡**:
- `$META`
- `$META_VAR`
- `$META_VAR1`
- `$_`
- `$_123`

**æ— æ•ˆçš„å…ƒå˜é‡**:
- `$invalid` (å°å†™å­—æ¯)
- `$Svalue` (å°å†™å­—æ¯å¼€å¤´)
- `$123` (æ•°å­—å¼€å¤´)
- `$KEBAB-CASE` (åŒ…å«ç ´æŠ˜å·)

æ¨¡å¼ `console.log($GREETING)` å¯ä»¥åŒ¹é…ä»¥ä¸‹æ‰€æœ‰ä»£ç ï¼š

```javascript
function tryAstGrep() {
  console.log('Hello World')
}

const multiLineExpression =
  console
   .log('Also matched!')
```

**ä½†å®ƒä¸ä¼šåŒ¹é…ä»¥ä¸‹ä»£ç **ï¼š

```javascript
// console.log(123) in comment is not matched
'console.log(123) in string' // is not matched as well
console.log() // mismatch argument
console.log(a, b) // too many arguments
```

æ³¨æ„ï¼Œä¸€ä¸ªå…ƒå˜é‡ `$MATCH` åªåŒ¹é…ä¸€ä¸ª AST èŠ‚ç‚¹ï¼Œæ‰€ä»¥æœ€åä¸¤ä¸ª `console.log` è°ƒç”¨æ— æ³•åŒ¹é…è¯¥æ¨¡å¼ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åŒ¹é…å¤šä¸ª AST èŠ‚ç‚¹ã€‚

## å¤šé‡å…ƒå˜é‡ (Multi Meta Variable)

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `$$$` æ¥åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ª AST èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬å‡½æ•°å‚æ•°ã€å‚æ•°æˆ–è¯­å¥ã€‚è¿™äº›å˜é‡ä¹Ÿå¯ä»¥å‘½åï¼Œä¾‹å¦‚ï¼š`console.log($$$ARGS)`ã€‚

### å‡½æ•°å‚æ•°

ä¾‹å¦‚ï¼Œ`console.log($$$)` å¯ä»¥åŒ¹é…ï¼š

```javascript
console.log()                       // matches zero AST node
console.log('hello world')          // matches one node
console.log('debug: ', key, value)  // matches multiple nodes
console.log(...args)                // it also matches spread
```

### å‡½æ•°å‚æ•°

`function $FUNC($$$ARGS) { $$$ }` å¯ä»¥åŒ¹é…ï¼š

```javascript
function foo(bar) {
  return bar
}

function noop() {}

function add(a, b, c) {
  return a + b + c
}
```

| åŒ¹é… | ARGS |
|------|------|
| `function foo(bar) { ... }` | `[bar]` |
| `function noop() {}` | `[]` |
| `function add(a, b, c) { ... }` | `[a, b, c]` |

## å…ƒå˜é‡æ•è· (Meta Variable Capturing)

å…ƒå˜é‡ä¹Ÿç±»ä¼¼äºæ­£åˆ™è¡¨è¾¾å¼ä¸­çš„æ•è·ç»„ã€‚æ‚¨å¯ä»¥é‡å¤ä½¿ç”¨ç›¸åŒåç§°çš„å…ƒå˜é‡æ¥æŸ¥æ‰¾å…ˆå‰å‡ºç°çš„ AST èŠ‚ç‚¹ã€‚

ä¾‹å¦‚ï¼Œæ¨¡å¼ `$A == $A` çš„ç»“æœå¦‚ä¸‹ï¼š

```javascript
// will match these patterns
a == a
1 + 1 == 1 + 1

// but will not match these
a == b
1 + 1 == 2
```

## éæ•è·åŒ¹é… (Non Capturing Match)

æ‚¨è¿˜å¯ä»¥ç¦æ­¢å…ƒå˜é‡æ•è·ã€‚æ‰€æœ‰ä»¥ä¸‹åˆ’çº¿ `_` å¼€å¤´çš„å…ƒå˜é‡éƒ½ä¸ä¼šè¢«æ•è·ã€‚

```javascript
// Given this pattern

$_FUNC($_FUNC)

// it will match all function call with one argument or spread call
test(a)
testFunc(1 + 1)
testFunc(...args)
```

æ³¨æ„ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå³ä½¿ä¸¤ä¸ªå…ƒå˜é‡å…·æœ‰ç›¸åŒçš„åç§° `$_FUNC`ï¼Œç”±äºå®ƒä»¬ä¸è¢«æ•è·ï¼Œæ¯æ¬¡å‡ºç°çš„ `$_FUNC` éƒ½å¯ä»¥åŒ¹é…ä¸åŒçš„å†…å®¹ã€‚

### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨éæ•è·åŒ¹é…ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªå¾®ä¼˜åŒ–æ¨¡å¼åŒ¹é…é€Ÿåº¦çš„æœ‰ç”¨æŠ€å·§ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦åˆ›å»º HashMap æ¥è¿›è¡Œè®°å½•ã€‚

## æ•è·æœªå‘½åçš„èŠ‚ç‚¹ (Capture Unnamed Nodes)

é»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒå˜é‡æ¨¡å¼ `$META` ä¼šæ•è·å‘½åçš„èŠ‚ç‚¹ã€‚è¦æ•è·æœªå‘½åçš„èŠ‚ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨åŒç¾å…ƒç¬¦å· `$$VAR`ã€‚

å‘½åæ€§ (Namedness) æ˜¯ Tree-sitter ä¸­çš„é«˜çº§ä¸»é¢˜ã€‚ä½ å¯ä»¥é˜…è¯»[è¿™ç¯‡æ·±å…¥æŒ‡å—](https://ast-grep.github.io/advanced/pattern-parse.html)äº†è§£æ›´å¤šèƒŒæ™¯çŸ¥è¯†ã€‚

## æ›´å¼ºå¤§çš„è§„åˆ™ (More Powerful Rule)

æ¨¡å¼æ˜¯åŒ¹é…ä»£ç çš„å¿«é€Ÿç®€ä¾¿æ–¹æ³•ï¼Œä½†å®ƒä¸å¦‚è§„åˆ™å¼ºå¤§ï¼Œè§„åˆ™å¯ä»¥ä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨æˆ–æ›´å¤šä¸Šä¸‹æ–‡æ¥åŒ¹é…ä»£ç ã€‚

æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« ä»‹ç»å¦‚ä½•ä½¿ç”¨è§„åˆ™ã€‚

> ğŸ’¡ **æç¤º**: åœ¨ YAML è§„åˆ™ä¸­ï¼Œæ¨¡å¼ä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡è€Œä¸æ˜¯å­—ç¬¦ä¸²ã€‚
>
> è¿™å¯¹äºé¿å…ä»£ç ç‰‡æ®µä¸­çš„æ­§ä¹‰éå¸¸æœ‰ç”¨ã€‚[ç‚¹å‡»æ­¤å¤„](https://ast-grep.github.io/reference/yaml.html)äº†è§£æ›´å¤šè¯¦æƒ…ã€‚
>
> å¦è¯·å‚é˜…æˆ‘ä»¬çš„ [FAQ](https://ast-grep.github.io/advanced/faq.html) ä»¥è·å–æ›´å¤šç¼–å†™æ¨¡å¼çš„æŒ‡å¯¼ã€‚

---

*æœ€åæ›´æ–°: 2024-01*
