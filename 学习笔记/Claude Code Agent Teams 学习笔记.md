## 概述

**Agent Teams（代理团队）** 是 Claude Code 的一个实验性功能，允许用户编排多个 Claude Code 实例作为团队协同工作，具备共享任务、代理间通信和集中管理等功能。

### 重要提示
- Agent teams 目前是实验性功能，默认禁用
- 需要通过添加 `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS` 到 settings.json 或环境变量来启用
- 存在会话恢复、任务协调和关闭行为等方面的已知限制

---

## 何时使用 Agent Teams

### 适用场景
1. **研究和审查**：多个代理可以同时调查问题的不同方面，然后分享和挑战彼此的发现
2. **新模块或功能开发**：代理可以各自拥有独立的部分，避免相互干扰
3. **竞争性假设调试**：代理并行测试不同理论，更快地收敛到答案
4. **跨层协调**：跨越前端、后端和测试的更改，每个部分由不同的代理负责

### 与 Subagents 的比较
（文档中提到了比较，但具体内容需要进一步了解）

---

## 开始使用 Agent Teams

### 启用 Agent Teams
1. 在 `settings.json` 中添加 `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS`
2. 或在环境变量中设置相应配置

### 启动第一个 Agent Team
Claude 创建团队的方式：
- **用户请求团队**：给 Claude 一个受益于并行工作的任务，并明确要求创建代理团队
- **Claude 提议团队**：如果 Claude 确定任务会受益于并行工作，它可能建议创建团队，需要用户确认后再继续

---

## 控制 Agent Team

### 选择显示模式

#### 1. In-Process（进程内模式）
- 所有代理在主终端内运行
- 使用 `Shift+Up/Down` 选择代理并直接输入消息
- 适用于任何终端，无需额外设置

#### 2. Split Panes（分窗格模式）
- 每个代理获得自己的窗格
- 可以同时看到所有人的输出并点击交互
- 需要 tmux 或 iTerm2

**tmux 要求**：
- 通过系统包管理器安装
- 参见 tmux wiki 获取平台特定说明

**iTerm2 要求**：
- 安装 it2 CLI
- 在 iTerm2 → 设置 → 通用 → 魔法 → 启用 Python API

### 指定代理和模型
- 可以为每个代理指定不同的模型
- 配置代理的角色和专业领域

### 要求代理的计划批准
- 可以设置需要用户批准代理的工作计划
- 确保工作方向符合预期

### 使用委托模式
- 启用代理之间的自主协调
- 减少用户手动干预需求

---

## 与代理直接沟通

### In-Process 模式
- 使用 `Shift+Up/Down` 选择代理
- 输入发送消息
- 按 `Enter` 查看代理会话
- 按 `Escape` 中断当前轮次
- 按 `Ctrl+T` 切换任务列表

### Split-Pane 模式
- 点击代理窗格直接交互
- 每个代理都有完整的终端视图

---

## 任务分配和管理

### 任务分配方式

#### Lead 分配（领导分配）
- 告诉领导将哪个任务分配给哪个代理

#### Self-Claim（自主认领）
- 代理完成任务后自行选择下一个未分配、未阻塞的任务

### 关闭代理
- 可以单独关闭特定代理
- 可以关闭整个团队

### 团队清理
- 完成工作后正确清理所有代理和资源
- 避免 orphaned tmux 会话

---

## 工作原理

### 架构组件
- **团队配置**：`~/.claude/teams/{team-name}/config.json`
- **任务列表**：`~/.claude/tasks/{team-name}/`

### 权限管理
- 代理具有适当的系统权限
- 可以访问必要的文件和系统资源

### 上下文和通信机制

#### 自动消息传递
- 代理发送消息时自动传递给接收者
- 领导无需轮询更新

#### 空闲通知
- 代理完成并停止时自动通知领导

#### 共享任务列表
- 所有代理都可以查看任务状态并认领可用工作

#### 消息类型
- `message`：发送消息给特定代理
- `broadcast`：同时发送给所有代理（谨慎使用，成本随团队规模增加）

### Token 使用
- 通信会消耗额外的 token
- 需要考虑成本效益

---

## 使用案例示例

### 并行代码审查
- 多个代理同时审查代码的不同部分
- 提高审查质量和效率

### 竞争性假设调查
- 代理并行测试不同理论
- 更快收敛到正确答案

---

## 最佳实践

### 提供足够上下文
- 为代理提供充分的任务背景信息
- 确保代理理解目标和约束

### 适当的任务规模
- 将任务分解为适当大小的子任务
- 避免过大或过小的任务粒度

### 等待代理完成
- 给代理足够时间完成分配的工作
- 避免过早干预

### 从研究和审查开始
- 先让代理进行研究和分析
- 然后基于结果进行决策

### 避免文件冲突
- 协调代理的文件访问权限
- 防止同时编辑同一文件

### 监控和引导
- 定期检查代理工作进展
- 根据需要提供指导和调整

---

## 故障排除

### 常见问题

#### 代理不出现
- 检查团队配置是否正确
- 验证权限设置

#### 太多权限提示
- 调整权限配置
- 减少不必要的权限请求

#### 代理在错误时停止
- 检查错误日志
- 提供更好的错误处理

#### 领导在完成工作前关闭
- 确保适当的工作流程
- 正确管理团队生命周期

#### Orphaned tmux 会话
- 定期清理孤立的 tmux 会话
- 监控资源使用情况

---

## 限制

Agent Teams 目前存在的已知限制：
- 会话恢复功能受限
- 任务协调机制需要改进
- 关闭行为可能不稳定

---

## 下一步

建议继续学习：
- 了解更多 Claude Code 功能
- 探索自定义子代理
- 学习插件创建
- 了解自动化钩子
- 掌握程序化使用方式

---

## 总结

Claude Code Agent Teams 是一个强大的功能，允许用户利用多个 AI 代理的并行工作能力来提高开发效率。虽然目前仍处于实验阶段，但已经为复杂任务的分解和并行处理提供了有价值的框架。通过合理的使用模式、最佳实践和适当的监控，Agent Teams 可以显著提升开发工作流程的效率和协作能力。

建议在实际使用中：
1. 从小规模试点开始
2. 积累使用经验
3. 根据具体需求调整配置
4. 关注功能发展和更新
